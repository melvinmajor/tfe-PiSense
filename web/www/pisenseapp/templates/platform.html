{% extends "_base.html" %}

{% block content %}
<div id="head">
  <h1>PiSense</h1>
  <p><em>Une solution IoT de prise de mesures</em>
    <br><small>Créé par Melvin Campos Casares pour <a href="https://dreamnetbe.net/" id="dreamnet">Dreamnet SRL</a>.</small></p>
</div>
<div class="main">
  <section id="box1" class="main">
    <h2>Plateforme</h2>
    <hr>
    <p><strong>Bienvenu {{ user_firstname }} {{ user_name }} !</strong></p>
    <p>D'après votre profil, vous disposez des capteurs suivants : <em>{{ user_sensors }}</em>
      <br>Votre identificateur PiSense est : <strong>{{ user_boxid }}</strong></p>
  </section>
  <section id="box2" class="main">
    <h2>Données</h2>
    <hr>
    <div class="alert alert-warning alert-dismissible fade show" role="alert">
      <button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button>
      <h4 class="alert-heading">Développement en cours</h4>
      <p>Les données affichées ne sont pas nécessairement des informations correctes.
        <br>L'indice de qualité de l'air est effectivement une suite de données récupérée à un instant T par le capteur SDS011.
        <br>Concernant la partie des graphiques, seul un est actuellement présent et les données affichées sont aléatoirement générées.</p>
      <div class="progress">
        <div class="progress-bar bg-info progress-bar-striped progress-bar-animated" role="progressbar" aria-valuenow="35" aria-valuemin="0" aria-valuemax="100" style="width: 35%"></div>
      </div>
    </div>

    <div class="container">
      <h2>Indice de qualité de l'air</h2>
      <hr>
      <p class="time-label"><em>Dernière mise à jour <small>(JJ.MM.AAAA HH:MM:SS)</small> :</em> <span class='time' id="time"></span></p>
      <div class="row">
        <div class='aqi-container twoColumn' id="containerPm25">
          <div class='aqi-label'>AQI (PM2.5)</div>
          <div class='aqi' id="aqiPm25"></div>
          <div class='pm-label' id="pm25"></div>
        </div>
        <div class='aqi-container twoColumn' id="containerPm10">
          <div class='aqi-label'>AQI (PM10)</div>
          <div class='aqi' id="aqiPm10"></div>
          <div class='pm-label' id="pm10"></div>
        </div>
      </div>

      <div class="row aqi-legend">
        <br>
        <div class="foo fa fa-circle lime"></div>0 à 50, bon
        <div class="foo fa fa-circle yellow"></div>51 à 100, moyen
        <div class="foo fa fa-circle orange"></div>101 à 150, mauvais pour les groupes sensibles
        <div class="foo fa fa-circle red"></div>151 à 200, mauvais
        <div class="foo fa fa-circle purple"></div>201 à 300, très mauvais
        <div class="foo fa fa-circle brown"></div>301 à 500, danger !
      </div>

    </div>
    <script>
      getData();
      setInterval(getData, 60000);
    </script>

    <div class="container">
      <h2>Graphiques</h2>
      <hr>
      <div>
        <canvas id="canvas"></canvas>
      </div>

      <button type="button" id="randomizeData" class="btn btn-secondary">Données aléatoires</button>
      <button type="button" id="addDataset" class="btn btn-secondary">Ajouter un jeu de données</button>
      <button type="button" id="removeDataset" class="btn btn-secondary">Enlever un jeu de données</button>
      <button type="button" id="addData" class="btn btn-secondary">Ajouter des données</button>
      <button type="button" id="removeData" class="btn btn-secondary">Enlever des données</button>

      <script>
      var MONTHS = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
      var config = {
        type: 'line',
        data: {
          labels: ['January', 'February', 'March', 'April', 'May', 'June', 'July'],
          datasets: [{
            label: 'Température (en °C)',
            backgroundColor: window.chartColors.blue,
            borderColor: window.chartColors.blue,
            data: [
              randomScalingFactor(),
              randomScalingFactor(),
              randomScalingFactor(),
              randomScalingFactor(),
              randomScalingFactor(),
              randomScalingFactor(),
              randomScalingFactor()
            ],
            fill: false,
          }, {
            label: 'Humidité (en %)',
            fill: false,
            backgroundColor: window.chartColors.purple,
            borderColor: window.chartColors.purple,
            data: [
              randomScalingFactor(),
              randomScalingFactor(),
              randomScalingFactor(),
              randomScalingFactor(),
              randomScalingFactor(),
              randomScalingFactor(),
              randomScalingFactor()
            ],
          }]
        },
        options: {
          responsive: true,
          title: {
            display: true,
            text: 'Graphique de température et humidité'
          },
          tooltips: {
            mode: 'index',
            intersect: false,
          },
          hover: {
            mode: 'nearest',
            intersect: true
          },
          scales: {
            x: {
              display: true,
              scaleLabel: {
                display: true,
                labelString: 'Month'
              }
            },
            y: {
              display: true,
              scaleLabel: {
                display: true,
                labelString: 'Value'
              }
            }
          }
        }
      };

      window.onload = function() {
        var ctx = document.getElementById('canvas').getContext('2d');
        window.myLine = new Chart(ctx, config);
      };

      document.getElementById('randomizeData').addEventListener('click', function() {
        config.data.datasets.forEach(function(dataset) {
          dataset.data = dataset.data.map(function() {
            return randomScalingFactor();
          });

        });

        window.myLine.update();
      });

      var colorNames = Object.keys(window.chartColors);
      document.getElementById('addDataset').addEventListener('click', function() {
        var colorName = colorNames[config.data.datasets.length % colorNames.length];
        var newColor = window.chartColors[colorName];
        var newDataset = {
          label: 'Dataset ' + config.data.datasets.length,
          backgroundColor: newColor,
          borderColor: newColor,
          data: [],
          fill: false
        };

        for (var index = 0; index < config.data.labels.length; ++index) {
          newDataset.data.push(randomScalingFactor());
        }

        config.data.datasets.push(newDataset);
        window.myLine.update();
      });

      document.getElementById('addData').addEventListener('click', function() {
        if (config.data.datasets.length > 0) {
          var month = MONTHS[config.data.labels.length % MONTHS.length];
          config.data.labels.push(month);

          config.data.datasets.forEach(function(dataset) {
            dataset.data.push(randomScalingFactor());
          });

          window.myLine.update();
        }
      });

      document.getElementById('removeDataset').addEventListener('click', function() {
        config.data.datasets.splice(0, 1);
        window.myLine.update();
      });

      document.getElementById('removeData').addEventListener('click', function() {
        config.data.labels.splice(-1, 1); // remove the label first

        config.data.datasets.forEach(function(dataset) {
          dataset.data.pop();
        });

        window.myLine.update();
      });
      </script>
    </div>
  </section>
</div>
 {% endblock %}